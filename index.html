<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intentional Evolution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDKs (Compatibility Version) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // --- Firebase Configuration ---
        // This is your project's configuration object.
        const firebaseConfig = {
            apiKey: "AIzaSyCMSrq9DoCu41pfAqawdMbLFXonagDrIAM",
            authDomain: "intentional-evolutionapp.firebaseapp.com",
            projectId: "intentional-evolutionapp",
            storageBucket: "intentional-evolutionapp.appspot.com",
            messagingSenderId: "81341452814",
            appId: "1:81341452814:web:a5df85de62da275c50625f",
            measurementId: "G-LQWZDT8MC5"
        };
        
        // --- IMPORTANT FIREBASE SETUP ---
        // For this app to save progress, you must set your Firestore Security Rules.
        // Go to your Firebase project -> Firestore Database -> Rules tab, and paste the following:
        /*
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            // Allow users to read and write only their own progress document.
            match /userProgress/{userId} {
              allow read, write: if request.auth != null && request.auth.uid == userId;
            }
          }
        }
        */

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- Data Model Classes ---
        class DigitalFountainStep {
            constructor(height, color, name, number, flow = "off") {
                this.height = height;
                this.color = color;
                this.flow = flow;
                this.name = name;
                this.number = number;
            }
        }

        class DigitalFountain {
            constructor(savedStepsData = null) {
                this.steps = [];
                if (savedStepsData) {
                    this.createStepsFromSavedData(savedStepsData);
                } else {
                    this.createSteps();
                }
            }

            createSteps() {
                const colors = ["#4A90E2", "#F5A623", "#D0021B", "#50E3C2", "#9013FE", "#BD10E0", "#4A4A4A", "#9B9B9B"];
                const aNames = ["Awareness", "Acceptance", "Assurance", "Adoration", "Association", "Assignment", "Accountability", "Assimilation"];
                for (let i = 0; i < aNames.length; i++) {
                    this.steps.push(new DigitalFountainStep(8 + (i * 2), colors[i], aNames[i], i + 1));
                }
            }
            
            createStepsFromSavedData(savedStepsData) {
                 this.steps = savedStepsData.map(data => 
                    new DigitalFountainStep(data.height, data.color, data.name, data.number, data.flow)
                );
            }
        }

        // --- Main React App Component ---
        const App = () => {
            const [fountain, setFountain] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [userId, setUserId] = useState(null);

            // Effect 1: Authenticate the user anonymously when the app loads.
            useEffect(() => {
                auth.signInAnonymously()
                    .then((userCredential) => {
                        const uid = userCredential.user.uid;
                        setUserId(uid);
                        console.log("Authenticated with User ID:", uid);
                    })
                    .catch((error) => {
                        console.error("Anonymous auth failed:", error);
                        setIsLoading(false); // Stop loading on auth failure
                    });
            }, []);

            // Effect 2: Load user's progress from Firestore once they are authenticated.
            useEffect(() => {
                if (!userId) return; // Don't run if we don't have a user ID yet.

                const userProgressRef = db.collection('userProgress').doc(userId);
                
                userProgressRef.get().then((doc) => {
                    let initialFountain;
                    if (doc.exists) {
                        console.log("Loading saved progress from Firestore.");
                        initialFountain = new DigitalFountain(doc.data().steps);
                    } else {
                        console.log("No saved progress found. Creating a new journey.");
                        initialFountain = new DigitalFountain();
                    }
                    setFountain(initialFountain);
                    setIsLoading(false);
                }).catch(error => {
                    console.error("Error loading progress:", error);
                    setFountain(new DigitalFountain()); // Fallback to a new fountain on error
                    setIsLoading(false);
                });

            }, [userId]); // This effect runs only when the userId is set.
            
            // Function to save the current progress to Firestore.
            const saveProgress = async (steps) => {
                if (!userId) return;
                const userProgressRef = db.collection('userProgress').doc(userId);
                const progressData = {
                    steps: steps.map(s => ({ name: s.name, number: s.number, color: s.color, height: s.height, flow: s.flow })),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };
                try {
                    await userProgressRef.set(progressData);
                    console.log("Progress saved to Firestore.");
                } catch (error) {
                    console.error("Error saving progress:", error);
                }
            };

            // Handler to reset the journey to its default state.
            const handleResetJourney = () => {
                setIsLoading(true);
                const newFountain = new DigitalFountain();
                setFountain(newFountain);
                saveProgress(newFountain.steps);
                setTimeout(() => setIsLoading(false), 300);
            };

            // Handler to toggle the "flow" of a single step.
            const handleToggleFlow = (stepName) => {
                const stepIndex = fountain.steps.findIndex(s => s.name === stepName);
                if (stepIndex === -1) return;

                // Create a new array of step data with the toggled flow
                const newStepsData = fountain.steps.map((step, index) => {
                    const stepData = { height: step.height, color: step.color, name: step.name, number: step.number, flow: step.flow };
                    if (index === stepIndex) {
                        stepData.flow = step.flow === "on" ? "off" : "on";
                    }
                    return stepData;
                });
                
                const newFountain = new DigitalFountain(newStepsData);
                setFountain(newFountain);
                saveProgress(newFountain.steps);
            };

            // Derive the ladder data directly from the fountain state for rendering.
            const ladderRungsData = (fountain && fountain.steps.length === 8) ? [
                [fountain.steps[1], fountain.steps[0]], // Acceptance, Awareness
                [fountain.steps[3], fountain.steps[2]], // Adoration, Assurance
                [fountain.steps[5], fountain.steps[4]], // Assignment, Association
                [fountain.steps[7], fountain.steps[6]], // Assimilation, Accountability
            ] : [];

            // Display a loading message while authenticating and fetching data.
            if (isLoading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-100">
                        <p className="text-xl text-gray-600">Loading Your Journey...</p>
                    </div>
                );
            }

            // --- Render the main application UI ---
            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-50 to-indigo-100 flex flex-col items-center justify-center p-4 font-sans text-gray-800 overflow-hidden">
                    <div className="bg-white p-8 rounded-2xl shadow-xl max-w-3xl w-full my-8 relative z-10">
                        <h1 className="text-5xl font-extrabold text-center text-indigo-700 mb-6">
                            Intentional Evolution
                        </h1>
                        <p className="text-xl text-center text-gray-600 mb-8">
                            Your journey through the 8 A's of Transformation.
                        </p>

                        <div className="flex justify-center mb-8">
                            <button
                                onClick={handleResetJourney}
                                className="px-8 py-4 bg-indigo-600 text-white font-bold text-lg rounded-xl shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition duration-300 ease-in-out transform hover:scale-105"
                            >
                                Reset Journey
                            </button>
                        </div>

                        {userId && (
                            <p className="text-sm text-gray-500 text-center mb-4">
                                User ID: <span className="font-mono bg-gray-100 px-2 py-1 rounded">{userId}</span>
                            </p>
                        )}
                    </div>

                    <div className="flex flex-col-reverse items-center relative w-full max-w-xl mx-auto pt-8 pb-16" style={{ perspective: '1000px' }}>
                        {ladderRungsData.map((rung, rungIndex) => (
                            <div
                                key={rungIndex}
                                className="flex justify-center w-full relative mb-12"
                                style={{
                                    zIndex: rungIndex,
                                    transform: `translateY(${rungIndex * -20}px) rotateX(5deg)`
                                }}
                            >
                                {rung.map((step) => (
                                    <div
                                        key={step.name}
                                        className="bg-white p-6 rounded-xl shadow-xl flex flex-col items-center justify-between text-center w-5/12 mx-2 transition duration-300 ease-in-out hover:shadow-2xl transform hover:scale-105"
                                        style={{
                                            backgroundColor: step.color,
                                            color: 'white',
                                            minHeight: '120px',
                                            border: '2px solid rgba(255,255,255,0.3)'
                                        }}
                                    >
                                        <div className="text-sm font-bold opacity-80 mb-1">A{step.number}</div>
                                        <h3 className="text-2xl font-bold mb-2">{step.name}</h3>
                                        <button
                                            onClick={() => handleToggleFlow(step.name)}
                                            className={`px-4 py-2 rounded-full text-xs font-medium ${
                                                step.flow === 'on'
                                                    ? 'bg-white bg-opacity-20 hover:bg-opacity-30'
                                                    : 'bg-gray-800 bg-opacity-20 hover:bg-opacity-30'
                                            } transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-75`}
                                        >
                                            Flow: {step.flow.toUpperCase()}
                                        </button>
                                    </div>
                                ))}
                            </div>
                        ))}
                    </div>

                    <p className="mt-8 text-center text-gray-500 text-sm">
                        Your progress is saved automatically.
                    </p>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
